<link rel="stylesheet" href="/style.css">

<!-- Add these to <head> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<header>
    <h1 class="no-print">Roshanlal Kedarnath Mandawar</h1>
    <select id="pageSelector" class="no-print">
        <option value="/work1">Price</option>
        <option value="/">Condition</option>
    </select>
</header>


<div class="main-container">
    <div class="form-container">
        <form id="entryForm" class="no-print">
            <input type="number" id="bags" placeholder="Bags" required>
            <input type="number" id="oil" step="0.01" min="0" placeholder="Oil%" required>
            <input type="number" id="rate" step="0.01" placeholder="Rate" required>
            <button type="submit">Submit</button>
        </form>
        <!-- Keep this OUTSIDE the form -->
        <div class="no-print">
                Majduri: <input type="number" id="majdur" step="0.01" placeholder="Majduri">
                <!-- <label>Majduri: <input type="number" id="muddat" step="0.01" placeholder="Muddat"> -->
                Date: <input type="date" id="dateInput" placeholder="Enter Date" class="work">
                Partty: 
                <!-- <input type="text" id="partySelect" placeholder="Enter Party Name" class="work"> -->
                 <select id="partySelect">
                    <option value="1"> C P AGRO INDUSTRIES ROOPBAS</option>
                    <option value="2">SHANTI OIL MILLS</option>
                    <option value="3">SANGAM INDUSTRIES</option>
                </select>
                <button id="bt" onclick="printTable()">Print</button>
                <button id="saveBtn" onclick="saveInvoice()">Save Invoice</button>
        </div>
    </div>


    <div class="table-container">
        <div id="printArea">

            <div style="text-align: center; font-family: serif;">
                <h2><strong>ROSHANLAL KEDARNATH</strong></h2>
                <p>B-21 NEW MANDI YARD MANDAWAR</p>
                <p><strong>Party: <span id="partyNameDisplay"></span></strong> | Date: <span id="invoiceDate"></span>
                </p>
                <!-- <span id="invoiceDate"></span></p> -->
            </div>

            <table border="1" id="dataTable">
                <!-- same table rows as you have now -->
                <tr>
                    <th>S. No.</th>
                    <th>Bags</th>
                    <th>Rate</th>
                    <th>Oil%</th>
                    <th>Condition</th>
                    <th>Weight</th>
                    <th>Amount</th>
                    <th class="no-print">Action</th>
                </tr>
                <tr id="totalsRow">
                    <td><strong>Total</strong></td>
                    <td id="totalBags">0</td>
                    <td id="weightedRate">0</td>
                    <td id="weightedOil">0</td>
                    <td id="weightedCondition">0</td>
                    <td id="totalWeight">0</td>
                    <td id="totalAmount">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>MANDI + DAMI + KKF</strong></td>
                    <td id="mandiAmount">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>MAJDURI</strong></td>
                    <td id="majdurAmount">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>MUDDAT @ 0.75%</strong></td>
                    <td id="muddatAmount">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>TOTAL</strong></td>
                    <td id="Total">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>GST @ 5%</strong></td>
                    <td id="gstAmount">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr>
                    <td colspan="6"><strong>GRAND TOTAL</strong></td>
                    <td id="grandTotal">0</td>
                    <td class="no-print"></td>
                </tr>
            </table>
            <div style="text-align: right; margin-top: 60px;">
                <p><strong>For Roshanlal Kedarnath</strong></p>
                <br>
                <h3 style="margin: 0;">Authorised sign.</h3>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('dateInput').valueAsDate = new Date();

</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let editRowIndex = null;

    $(document).ready(function () {
        $('#entryForm').on('submit', function (e) {
            e.preventDefault();

            const bags = parseInt($('#bags').val());
            const oil = parseFloat($('#oil').val());
            const rate = parseFloat($('#rate').val());

            const condition = ((rate / oil) * 42).toFixed(2);
            const weight = (bags * 0.5).toFixed(2);
            const amount = (weight * rate).toFixed(2);

            if (editRowIndex !== null) {
                const row = $('#dataTable tr').eq(editRowIndex);
                row.find('td').eq(1).text(bags);
                row.find('td').eq(2).text(rate);
                row.find('td').eq(3).text(oil);
                row.find('td').eq(4).text(condition);
                row.find('td').eq(5).text(weight);
                row.find('td').eq(6).text(amount);
                editRowIndex = null;
            } else {
                const rowCount = $('#dataTable tr').filter(function () {
                    return !$(this).attr('id') && $(this).find('td').length > 0;
                }).length - 5;

                const newRow = `
                    <tr>
                        <td>${rowCount}</td>
                        <td>${bags}</td>
                        <td>${rate}</td>
                        <td>${oil}</td>
                        <td>${condition}</td>
                        <td>${weight}</td>
                        <td>${amount}</td>
                        <td class="no-print">
    <button class="edit-btn">Edit</button>
    <button class="delete-btn" style="margin-left: 1px; background-color: red; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
</td>

                    </tr>
                `;
                $('#totalsRow').before(newRow);
            }

            updateTotals();
            this.reset();
        });

        $('#dataTable').on('click', '.edit-btn', function () {
            const row = $(this).closest('tr');
            editRowIndex = row.index();
            const cells = row.find('td');
            $('#rate').val(cells.eq(2).text());
            $('#oil').val(cells.eq(3).text());
            $('#bags').val(cells.eq(1).text());

        });

        $('#dataTable').on('click', '.delete-btn', function () {
            $(this).closest('tr').remove();
            renumberRows();
            updateTotals();
        });

        $('#partySelect').on('input', function () {
            const partyName = $(this).val().trim();
            $('#partyNameDisplay').text(partyName || ""); // shows blank if empty
        });

        $('#majdur').on('change', function () {
            updateTotals();
        });
    });

    function renumberRows() {
        let serial = 0;

        $('#dataTable tr').each(function () {
            const $row = $(this);
            // Skip rows with specific IDs or summary content
            if (
                $row.attr('id') === 'totalsRow' ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('total') ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('mandi') ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('majduri') ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('muddat') ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('gst') ||
                $row.find('td').eq(0).text().trim().toLowerCase().includes('grand')
            ) {
                return;
            }

            $row.find('td').eq(0).text(serial++);
        });
    }


    function updateTotals() {
        let totalBags = 0;
        let totalWeight = 0;
        let totalAmount = 0;
        let weightedRateSum = 0;
        let weightedOilSum = 0;
        let weightedConditionSum = 0;

        $('#dataTable tr').each(function (index) {
            if (index === 0 || $(this).attr('id') === 'totalsRow') return;

            const cells = $(this).find('td');
            if (cells.length < 7) return;

            const bags = parseFloat(cells.eq(1).text()) || 0;
            const rate = parseFloat(cells.eq(2).text()) || 0;
            const oil = parseFloat(cells.eq(3).text()) || 0;
            const condition = parseFloat(cells.eq(4).text()) || 0;
            const weight = parseFloat(cells.eq(5).text()) || 0;
            const amount = parseFloat(cells.eq(6).text()) || 0;

            totalBags += bags;
            totalWeight += weight;
            totalAmount += amount;
            weightedRateSum += rate * bags;
            weightedOilSum += oil * bags;
            weightedConditionSum += condition * bags;
        });

        const mandiPercent = 3.75;
        const majdur = parseFloat($('#majdur').val()) || 0;
        const mandiAmount = (totalAmount * (mandiPercent / 100));
        const muddat = (totalAmount) * 0.0075;
        const Total = totalAmount + mandiAmount + majdur + muddat;
        const gst = (totalAmount + mandiAmount + majdur + muddat) * 0.05;
        const grandTotal = totalAmount + mandiAmount + majdur + muddat + gst;

        $('#totalBags').text(totalBags.toFixed(2));
        $('#totalWeight').text(totalWeight.toFixed(2));
        $('#totalAmount').text(totalAmount.toFixed(2));
        $('#weightedRate').text((weightedRateSum / totalBags).toFixed(2));
        $('#weightedOil').text((weightedOilSum / totalBags).toFixed(2));
        $('#weightedCondition').text((weightedConditionSum / totalBags).toFixed(2));

        $('#mandiAmount').text(mandiAmount.toFixed(2));
        $('#majdurAmount').text(majdur.toFixed(2));
        $('#muddatAmount').text(muddat.toFixed(2));
        $('#Total').text(Total.toFixed(2));
        $('#gstAmount').text(gst.toFixed(2));
        $('#grandTotal').text(grandTotal.toFixed(2));

        // Update the readonly mandi field
        $('#mandi').val(mandiAmount.toFixed(2));
    }

</script>

<script src="/id.js"></script>